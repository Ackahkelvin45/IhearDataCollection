{% extends 'datacollection/layout.html' %}

{% block content %}
<div class="flex flex-wrap -mx-3">
  <div class="w-full px-6 py-6 mx-auto">
    <div class="relative flex flex-col min-w-0 break-words bg-white border-0 shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
      <div class="border-black/12.5 rounded-t-2xl border-b-0 border-solid p-6 pb-0">
        <h6>Bulk Audio Upload</h6>
      </div>

      <div class="flex-auto p-6">
        <form id="bulk-upload-form" method="post" enctype="multipart/form-data">
          {% csrf_token %}

               <!-- Basic Information -->
              <p class="leading-normal uppercase dark:text-white dark:opacity-60 text-sm">Basic Information</p>
              <div class="flex flex-wrap -mx-3">
                <div class="w-full max-w-full px-3 shrink-0 md:w-full md:flex-0">
                  <div class="mb-4">
                    <label for="id_description" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">{{ form.description.label }}</label>
                    {{ form.description }}
                    {% if form.description.help_text %}
                      <small class="text-xs text-slate-500 dark:text-white/60">{{ form.description.help_text }}</small>
                    {% endif %}
                    {% if form.description.errors %}
                      <div class="text-red-500 text-xs mt-1">{{ form.description.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
                  <div class="mb-4">
                    <label for="id_category" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">{{ form.category.label }}</label>
                    {{ form.category }}
                    {% if form.category.help_text %}
                      <small class="text-xs text-slate-500 dark:text-white/60">{{ form.category.help_text }}</small>
                    {% endif %}
                    {% if form.category.errors %}
                      <div class="text-red-500 text-xs mt-1">{{ form.category.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
                  <div class="mb-4">
                    <label for="id_class_name" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">{{ form.class_name.label }}</label>
                    {{ form.class_name }}
                    {% if form.class_name.help_text %}
                      <small class="text-xs text-slate-500 dark:text-white/60">{{ form.class_name.help_text }}</small>
                    {% endif %}
                    {% if form.class_name.errors %}
                      <div class="text-red-500 text-xs mt-1">{{ form.class_name.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
                  <div class="mb-4">
                    <label for="id_subclass" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Sub Class</label>
                    {{ form.subclass }}
                    {% if form.subclass.help_text %}
                      <small class="text-xs text-slate-500 dark:text-white/60">{{ form.subclass.help_text }}</small>
                    {% endif %}
                    {% if form.subclass.errors %}
                      <div class="text-red-500 text-xs mt-1">{{ form.subclass.errors }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <hr class="h-px mx-0 my-4 bg-transparent border-0 opacity-25 bg-gradient-to-r from-transparent via-black/40 to-transparent dark:bg-gradient-to-r dark:from-transparent dark:via-white dark:to-transparent " />

              <!-- Location Information -->
              <p class="leading-normal uppercase dark:text-white dark:opacity-60 text-sm">Location Information</p>
              <div class="flex flex-wrap -mx-3">
                <div class="w-full max-w-full px-3 shrink-0 md:w-4/12 md:flex-0">
                  <div class="mb-4">
                    <label for="id_region" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">{{ form.region.label }}</label>
                    {{ form.region }}
                    {% if form.region.help_text %}
                      <small class="text-xs text-slate-500 dark:text-white/60">{{ form.region.help_text }}</small>
                    {% endif %}
                    {% if form.region.errors %}
                      <div class="text-red-500 text-xs mt-1">{{ form.region.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="w-full max-w-full px-3 shrink-0 md:w-4/12 md:flex-0">
                  <div class="mb-4">
                    <label for="id_community" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">{{ form.community.label }}</label>
                    {{ form.community }}
                    {% if form.community.help_text %}
                      <small class="text-xs text-slate-500 dark:text-white/60">{{ form.community.help_text }}</small>
                    {% endif %}
                    {% if form.community.errors %}
                      <div class="text-red-500 text-xs mt-1">{{ form.community.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
                  <div class="mb-4">
                    <label for="id_time_of_day" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">{{ form.time_of_day.label }}</label>
                    {{ form.time_of_day }}
                    {% if form.time_of_day.help_text %}
                      <small class="text-xs text-slate-500 dark:text-white/60">{{ form.time_of_day.help_text }}</small>
                    {% endif %}
                    {% if form.time_of_day.errors %}
                      <div class="text-red-500 text-xs mt-1">{{ form.time_of_day.errors }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <hr class="h-px mx-0 my-4 bg-transparent border-0 opacity-25 bg-gradient-to-r from-transparent via-black/40 to-transparent dark:bg-gradient-to-r dark:from-transparent dark:via-white dark:to-transparent " />

              <!-- Recording Information -->
              <p class="leading-normal uppercase dark:text-white dark:opacity-60 text-sm">Recording Information</p>
              <div class="flex flex-wrap -mx-3">
                <div class="w-full max-w-full px-3 shrink-0 md:w-full md:flex-0">
                  <div class="mb-4">
                    <label for="id_audio" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">{{ form.audio.label }}</label>
                    {{ form.audio }}
                    {% if form.audio.help_text %}
                      <small class="text-xs text-slate-500 dark:text-white/60">{{ form.audio.help_text }}</small>
                    {% endif %}
                    {% if form.audio.errors %}
                      <div class="text-red-500 text-xs mt-1">{{ form.audio.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
                  <div class="mb-4">
                    <label for="id_recording_date" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">{{ form.recording_date.label }}</label>
                    {{ form.recording_date }}
                    {% if form.recording_date.help_text %}
                      <small class="text-xs text-slate-500 dark:text-white/60">{{ form.recording_date.help_text }}</small>
                    {% endif %}
                    {% if form.recording_date.errors %}
                      <div class="text-red-500 text-xs mt-1">{{ form.recording_date.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
                  <div class="mb-4">
                    <label for="id_recording_device" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">{{ form.recording_device.label }}</label>
                    {{ form.recording_device }}
                    {% if form.recording_device.help_text %}
                      <small class="text-xs text-slate-500 dark:text-white/60">{{ form.recording_device.help_text }}</small>
                    {% endif %}
                    {% if form.recording_device.errors %}
                      <div class="text-red-500 text-xs mt-1">{{ form.recording_device.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="w-full max-w-full px-3 shrink-0 md:w-full md:flex-0">
                  <div class="mb-4">
                    <label for="id_microphone_type" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">{{ form.microphone_type.label }} <span class="text-slate-400">(Optional)</span></label>
                    {{ form.microphone_type }}
                    {% if form.microphone_type.help_text %}
                      <small class="text-xs text-slate-500 dark:text-white/60">{{ form.microphone_type.help_text }}</small>
                    {% endif %}
                    {% if form.microphone_type.errors %}
                      <div class="text-red-500 text-xs mt-1">{{ form.microphone_type.errors }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>


          <!-- Same metadata fields as single upload -->
          <div class="flex flex-wrap -mx-3">



              <!-- Form Errors -->
              {% if form.non_field_errors %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                  {{ form.non_field_errors }}
                </div>
              {% endif %}

            <div class="w-full max-w-full px-3 shrink-0 md:w-full md:flex-0">
              <div class="mb-4">
                <label for="id_audio_files" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Audio Files</label>
                <input type="file" name="audio_files" id="id_audio_files" multiple
                  class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm leading-5.6 ease block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-blue-500 focus:outline-none"
                  accept="audio/*">
                <small class="text-xs text-slate-500 dark:text-white/60">Select multiple audio files (50+ files supported)</small>
              </div>
            </div>
          </div>

          <div class="flex justify-end mt-6">
            <button type="submit" class="inline-block px-8 py-2 font-bold leading-normal text-center text-white align-middle transition-all ease-in bg-primary border-0 rounded-lg shadow-md cursor-pointer text-xs tracking-tight-rem hover:shadow-xs hover:-translate-y-px active:opacity-85">
              Start Bulk Upload
            </button>
          </div>
        </form>

        <!-- Progress section (hidden initially) -->
        <div id="progress-section" class="mt-8 hidden">
          <h6 class="mb-4">Upload Progress</h6>
          <div class="relative pt-1">
            <div class="flex mb-2 items-center justify-between">
              <div>
                <span id="progress-status" class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">
                  Starting...
                </span>
              </div>
              <div class="text-right">
                <span id="progress-count" class="text-xs font-semibold inline-block text-blue-600">
                  0/0
                </span>
              </div>
            </div>
            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-blue-200">
              <div id="progress-bar" style="width:0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500"></div>
            </div>
            <div id="failed-files" class="text-xs text-red-500 hidden">
              <span id="failed-count">0</span> files failed to process
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

        const recordingDateField = document.getElementById('id_recording_date');
      if (recordingDateField && !recordingDateField.value) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        recordingDateField.value = `${year}-${month}-${day}T${hours}:${minutes}`;
      }


  const form = document.getElementById('bulk-upload-form');
  const progressSection = document.getElementById('progress-section');
  const progressStatus = document.getElementById('progress-status');
  const progressCount = document.getElementById('progress-count');
  const progressBar = document.getElementById('progress-bar');
  const failedFiles = document.getElementById('failed-files');
  const failedCount = document.getElementById('failed-count');

  let bulkUploadId = null;
  let progressInterval = null;

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(form);

    // Show progress section
    progressSection.classList.remove('hidden');
    progressStatus.textContent = 'Uploading...';

    fetch('{% url "data:bulk_upload" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        bulkUploadId = data.bulk_upload_id;
        progressStatus.textContent = 'Processing...';

        // Start polling for progress
        progressInterval = setInterval(checkProgress, 2000);
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred during upload');
    });
  });

  function checkProgress() {
    if (!bulkUploadId) return;

    fetch(`/api/bulk-upload-progress/${bulkUploadId}/`)
      .then(response => response.json())
      .then(data => {
        const processed = data.processed || 0;
        const total = data.total || 1;
        const failed = data.failed || 0;
        const percentage = Math.round((processed / total) * 100);

        progressCount.textContent = `${processed}/${total}`;
        progressBar.style.width = `${percentage}%`;

        if (failed > 0) {
          failedFiles.classList.remove('hidden');
          failedCount.textContent = failed;
        }

        if (data.status === 'completed' || data.status === 'completed_with_errors') {
          progressStatus.textContent = data.status === 'completed' ? 'Completed!' : 'Completed with errors';
          clearInterval(progressInterval);

          if (data.status === 'completed') {
            setTimeout(() => {
              window.location.href = '{% url "data:datasetlist" %}';
            }, 2000);
          }
        }
      })
      .catch(error => {
        console.error('Error checking progress:', error);
      });
  }

  // Initialize dynamic selects as in your single upload form
  // ...
});
</script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    // Get all select elements
    const regionSelect = document.getElementById('id_region');
    const communitySelect = document.getElementById('id_community');
    const categorySelect = document.getElementById('id_category');
    const classSelect = document.getElementById('id_class_name');
    const subclassSelect = document.getElementById('id_subclass');

    // Region-Community relationship
    if (regionSelect && communitySelect) {
        regionSelect.addEventListener('change', function() {
            const regionId = this.value;
            communitySelect.innerHTML = '<option value="">Select Community</option>';

            if (regionId) {
                fetch(`/load-communities/?region_id=${regionId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = item.name;
                            communitySelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading communities:', error));
            }
        });
    }

    // Category-Class relationship
    if (categorySelect && classSelect) {
        categorySelect.addEventListener('change', function() {
            const categoryId = this.value;
            classSelect.innerHTML = '<option value="">Select Class</option>';
            if (subclassSelect) subclassSelect.innerHTML = '<option value="">Select Sub Class</option>';

            if (categoryId) {
                fetch(`/load-classes/?category_id=${categoryId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = item.name;
                            classSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading classes:', error));
            }
        });
    }

    // Class-Subclass relationship
    if (classSelect && subclassSelect) {
        classSelect.addEventListener('change', function() {
            const classId = this.value;
            subclassSelect.innerHTML = '<option value="">Select Sub Class</option>';

            if (classId) {
                fetch(`/load-subclasses/?class_id=${classId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = item.name;
                            subclassSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading subclasses:', error));
            }
        });
    }

    // Trigger change events for pre-selected values (when editing)
    if (regionSelect && regionSelect.value) {
        regionSelect.dispatchEvent(new Event('change'));
    }
    if (categorySelect && categorySelect.value) {
        categorySelect.dispatchEvent(new Event('change'));
    }
    if (classSelect && classSelect.value) {
        // Add a small delay to ensure classes are loaded first
        setTimeout(() => {
            classSelect.dispatchEvent(new Event('change'));
        }, 100);
    }
});


 </script>


  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.close-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          e.target.closest('.alert').remove();
        });
      });

      setTimeout(() => {
        document.querySelectorAll('.alert').forEach(alert => {
          alert.remove();
        });
      }, 7000);

    });
  </script>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}
