{% extends 'datacollection/layout.html'%}

{% block content %}
  <nav class="justify-end flex items-center">
      <select placeholder="Default input" class="focus:shadow-primary-outline text-sm mb-2  leading-5.6 ease block  w-fit rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-blue-500 focus:outline-none">
            <option>All</option>
      </select>
  </nav>

  <!-- Loading Skeleton -->
  <div id="loadingSkeleton" class="block">
    <!-- Stats Cards Skeleton -->
    <div class="flex flex-wrap -mx-3">
      {% for i in "1234567890123456" %}
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-gray-200 dark:bg-slate-700 shadow-xl rounded-2xl animate-pulse">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <div class="h-4 bg-gray-300 dark:bg-slate-600 rounded mb-2"></div>
                <div class="h-6 bg-gray-300 dark:bg-slate-600 rounded mb-2 mt-4"></div>
                <div class="h-3 bg-gray-300 dark:bg-slate-600 rounded"></div>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gray-300 dark:bg-slate-600"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Average Parameters Table Skeleton -->
    <div class="flex-none w-full max-w-full px-3 mb-6">
      <div class="relative flex flex-col min-w-0 break-words bg-gray-200 dark:bg-slate-700 shadow-xl rounded-2xl animate-pulse">
        <div class="p-6 pb-0 mb-0 border-b-0 border-b-solid rounded-t-2xl border-b-transparent">
          <div class="h-6 bg-gray-300 dark:bg-slate-600 rounded mb-2 w-1/3"></div>
        </div>
        <div class="p-6 pb-0 mb-0 border-b-0 border-b-solid rounded-t-2xl border-b-transparent">
          <div class="flex gap-2 mb-4">
            <div class="h-8 bg-gray-300 dark:bg-slate-600 rounded w-20"></div>
            <div class="h-8 bg-gray-300 dark:bg-slate-600 rounded w-20"></div>
            <div class="h-8 bg-gray-300 dark:bg-slate-600 rounded w-20"></div>
            <div class="h-8 bg-gray-300 dark:bg-slate-600 rounded w-20"></div>
            <div class="h-8 bg-gray-300 dark:bg-slate-600 rounded w-20"></div>
          </div>
        </div>
        <div class="flex-auto px-0 pt-0 pb-2">
          <div class="p-0 overflow-x-auto">
            <div class="h-64 bg-gray-300 dark:bg-slate-600 rounded mx-6"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Skeleton -->
    <div class="flex flex-wrap mt-6 -mx-3">
      <div class="w-full px-3 mb-6 lg:mb-0 lg:w-1/2 lg:flex-none">
        <div class="relative flex flex-col h-full min-w-0 break-words bg-gray-200 dark:bg-slate-700 shadow-xl rounded-2xl animate-pulse">
          <div class="p-4 pb-0 rounded-t-4">
            <div class="h-6 bg-gray-300 dark:bg-slate-600 rounded mb-2 w-1/2"></div>
            <div class="h-4 bg-gray-300 dark:bg-slate-600 rounded w-2/3"></div>
          </div>
          <div class="flex-auto p-4">
            <div class="h-64 bg-gray-300 dark:bg-slate-600 rounded"></div>
          </div>
        </div>
      </div>
      <div class="w-full px-3 lg:w-1/2 lg:flex-none">
        <div class="relative flex flex-col h-full min-w-0 break-words bg-gray-200 dark:bg-slate-700 shadow-xl rounded-2xl animate-pulse">
          <div class="p-4 pb-0 rounded-t-4">
            <div class="h-6 bg-gray-300 dark:bg-slate-600 rounded mb-2 w-1/2"></div>
            <div class="h-4 bg-gray-300 dark:bg-slate-600 rounded w-2/3"></div>
          </div>
          <div class="flex-auto p-4">
            <div class="h-64 bg-gray-300 dark:bg-slate-600 rounded"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Additional rows of skeleton charts would go here -->
  </div>

  <!-- Dashboard Content (initially hidden) -->
  <div id="dashboardContent" class="hidden">
    <!-- row 1 - Stats Cards -->
    <div class="flex flex-wrap -mx-3">
      <!-- Section: Totals -->
      <div class="w-full max-w-full px-3 mb-3">
        <h6 class="text-slate-700 dark:text-white">Totals</h6>
      </div>

      <!-- Total Data (All) -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Total Data</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="totalAllData">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Noise + Clean Speech</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-slate-700 to-slate-500">
                  <i class="ni ni-collection text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Your Total Contributions -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Your Total Contributions</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="userAllData">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Noise + Clean Speech</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-emerald-600 to-teal-500">
                  <i class="ni ni-single-02 text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Total Duration (All) -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Total Duration</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="totalAllDurationHours">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Hours (All data)</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-zinc-800 to-slate-600">
                  <i class="ni ni-time-alarm text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Average Duration (All) -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Average Duration</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="averageAllDurationSeconds">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Seconds (All data)</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-purple-500 to-pink-500">
                  <i class="ni ni-time-alarm text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Noise -->
      <div class="w-full max-w-full px-3 mb-3">
        <h6 class="text-slate-700 dark:text-white">Noise</h6>
      </div>

      <!-- Total Noise Recordings -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Total Noise Recordings</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="totalRecordings">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">All users</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-blue-500 to-violet-500">
                  <i class="ni ni-sound-wave text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Your Noise Recordings -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Your Noise Recordings</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="userRecordings">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Your contributions</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-emerald-500 to-teal-400">
                  <i class="ni ni-single-02 text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Noise Duration -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Noise Duration</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="totalDurationHours">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Hours of audio</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-zinc-800 to-slate-600">
                  <i class="ni ni-time-alarm text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Noise Avg Duration -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Noise Avg Duration</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="averageDurationSeconds">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Seconds per recording</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-purple-500 to-pink-500">
                  <i class="ni ni-time-alarm text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Clean Speech -->
      <div class="w-full max-w-full px-3 mt-2 mb-3">
        <h6 class="text-slate-700 dark:text-white">Clean Speech</h6>
      </div>

      <!-- Clean Speech Recordings -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Clean Speech Recordings</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="cleanSpeechRecordings">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Approved only</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-indigo-500 to-sky-500">
                  <i class="ni ni-chat-round text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Your Clean Speech -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Your Clean Speech</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="userCleanSpeechRecordings">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Approved only</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-fuchsia-500 to-pink-500">
                  <i class="ni ni-single-02 text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Clean Speech Duration -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Clean Speech Duration</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="cleanSpeechDurationHours">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Hours of audio</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-amber-500 to-orange-500">
                  <i class="ni ni-time-alarm text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Clean Speech Avg Duration -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Clean Speech Avg Duration</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="cleanSpeechAverageDurationSeconds">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Seconds per recording</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-teal-500 to-emerald-500">
                  <i class="ni ni-time-alarm text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Metadata -->
      <div class="w-full max-w-full px-3 mt-2 mb-3">
        <h6 class="text-slate-700 dark:text-white">Metadata</h6>
      </div>

      <!-- Categories -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Categories</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="categoriesCount">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Different types</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-orange-500 to-yellow-500">
                  <i class="ni ni-collection text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Classes -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Classes</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="classesCount">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Different types</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-blue-700 to-cyan-500">
                  <i class="ni ni-books text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sub Classes -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Sub Classes</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="subClassesCount">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Different types</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-green-600 to-lime-400">
                  <i class="ni ni-ungroup text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Regions -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4">
        <div class="relative flex flex-col bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 px-3">
                <p class="mb-0 text-sm font-semibold uppercase dark:text-white dark:opacity-60">Regions</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white" id="regionsCount">0</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60"><span class="font-bold">Covered areas</span></p>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-red-600 to-orange-600">
                  <i class="ni ni-map-big text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- row 1b - Hours by Class Cards -->
    <div id="classHoursContainer" class="flex flex-wrap -mx-3 mt-6">
      <!-- Will be populated by JavaScript -->
    </div>

    <!-- row 2 - Main Charts -->
    <div class="flex flex-wrap mt-6 -mx-3">
      <!-- Pie Chart: Recordings by Category -->

          <div class="flex-none w-full max-w-full px-3">
            <div class="relative flex flex-col min-w-0 mb-6 break-words bg-white border-0 border-transparent border-solid shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
              <div class="p-6 pb-0 mb-0 border-b-0 border-b-solid rounded-t-2xl border-b-transparent">
                <h6 class="dark:text-white">parameters</h6>
              </div>

              <div class="p-6 pb-0 mb-0 border-b-0 border-b-solid rounded-t-2xl border-b-transparent">
                <div class="flex flex-wrap gap-2 mb-4">
                  <button id="filter-category" style="margin-right: 3px;" class="filter-btn mr-2  active inline-block px-6 py-2 mb-0 text-xs font-bold leading-normal text-center text-white align-middle transition-all ease-in bg-blue-500 border border-blue-500 border-solid rounded-lg shadow-none cursor-pointer hover:bg-blue-600 hover:border-blue-600 tracking-tight-rem" data-filter="category" onclick="handleFilterClick('category')">Categories</button>
                  <button id="filter-class"  style="margin-right: 3px;"  class="filter-btn  mr-2  inline-block px-6 py-2 mb-0 text-xs font-bold leading-normal text-center text-primary align-middle transition-all ease-in bg-transparent border border-primary border-solid rounded-lg shadow-none cursor-pointer hover:bg-blue-50 hover:border-blue-600 tracking-tight-rem" data-filter="class" onclick="handleFilterClick('class')">Classes</button>
                  <button id="filter-subclass" style="margin-right: 3px;"  class="filter-btn  mr-2  inline-block px-6 py-2 mb-0 text-xs font-bold leading-normal text-center text-primary align-middle transition-all ease-in bg-transparent border border-primary border-solid rounded-lg shadow-none cursor-pointer hover:bg-blue-50 hover:border-blue-600 tracking-tight-rem" data-filter="subclass" onclick="handleFilterClick('subclass')">Sub Classes</button>
                  <button id="filter-region"  style="margin-right: 3px;"  class="filter-btn  mr-2  inline-block px-6 py-2 mb-0 text-xs font-bold leading-normal text-center text-primary align-middle transition-all ease-in bg-transparent border border-primary border-solid rounded-lg shadow-none cursor-pointer hover:bg-blue-50 hover:border-blue-600 tracking-tight-rem" data-filter="region" onclick="handleFilterClick('region')">Regions</button>
                  <button id="filter-community" style="margin-right: 3px;"   class="filter-btn  mr-2  inline-block px-6 py-2 mb-0 text-xs font-bold leading-normal text-center text-primary align-middle transition-all ease-in bg-transparent border border-primary border-solid rounded-lg shadow-none cursor-pointer hover:bg-blue-50 hover:border-blue-600 tracking-tight-rem" data-filter="community" onclick="handleFilterClick('community')">Communities</button>
                  <div class="ml-auto flex items-center mt-2 gap-2">
                    <label for="unit-select" class="text-xs font-bold text-slate-600 dark:text-white/80 mr-2 ">Duration Unit</label>
                    <select id="unit-select" class="unit-select focus:shadow-primary-outline text-xs leading-5.6 ease block w-fit rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-blue-500 focus:outline-none">
                      <option value="seconds" selected>Seconds</option>
                      <option value="hours">Hours</option>
                    </select>
                  </div>
              </div>
              </div>
              <!-- Loading skeleton for table -->
              <div id="tableLoadingSkeleton" class="flex-auto px-0 pt-0 pb-2 hidden">
                <div class="p-0 overflow-x-auto">
                  <div class="mx-6">
                    <div class="animate-pulse">
                      <div class="h-4 bg-gray-300 dark:bg-slate-600 rounded mb-4"></div>
                      <div class="space-y-3">
                        <div class="h-3 bg-gray-300 dark:bg-slate-600 rounded"></div>
                        <div class="h-3 bg-gray-300 dark:bg-slate-600 rounded"></div>
                        <div class="h-3 bg-gray-300 dark:bg-slate-600 rounded"></div>
                        <div class="h-3 bg-gray-300 dark:bg-slate-600 rounded"></div>
                        <div class="h-3 bg-gray-300 dark:bg-slate-600 rounded"></div>
                            </div>
                            </div>
                          </div>
                            </div>
                            </div>

              <!-- Table content -->
              <div id="tableContent" class="flex-auto px-0 pt-0 pb-2">
                <div class="p-0 overflow-x-auto">
                  <table class="items-center w-full mb-0 align-top border-collapse dark:border-white/40 text-slate-500">
                    <thead class="align-bottom">
                      <tr>
                        <th class="px-6 py-3 font-bold text-left uppercase align-middle bg-transparent border-b border-collapse shadow-none dark:border-white/40 dark:text-white text-xxs border-b-solid tracking-none whitespace-nowrap text-slate-400 opacity-70">Name</th>
                        <th class="px-6 py-3 pl-2 font-bold text-left uppercase align-middle bg-transparent border-b border-collapse shadow-none dark:border-white/40 dark:text-white text-xxs border-b-solid tracking-none whitespace-nowrap text-slate-400 opacity-70">Total Count</th>
                        <th class="px-6 py-3 pl-2 font-bold text-left uppercase align-middle bg-transparent border-b border-collapse shadow-none dark:border-white/40 dark:text-white text-xxs border-b-solid tracking-none whitespace-nowrap text-slate-400 opacity-70">Average Duration (<span id="avgDurationHeaderUnit">s</span>)</th>
                        <th class="px-6 py-3 pl-2 font-bold text-left uppercase align-middle bg-transparent border-b border-collapse shadow-none dark:border-white/40 dark:text-white text-xxs border-b-solid tracking-none whitespace-nowrap text-slate-400 opacity-70">Total Duration (<span id="totalDurationHeaderUnit">s</span>)</th>
                      </tr>
                    </thead>
                    <tbody id="averageParametersTableBody">
                      <!-- Data will be populated by JavaScript -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>


      <div class="w-full px-3 mb-6 lg:mb-0 lg:w-1/2 lg:flex-none">
        <div class="relative flex flex-col h-full min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="p-4 pb-0 rounded-t-4">
            <h6 class="mb-1 dark:text-white">Recordings by Category</h6>
            <p class="text-sm leading-normal dark:text-white dark:opacity-60">Distribution of recordings (Noise + Clean Speech) across categories</p>
          </div>
          <div class="flex-auto p-4">
            <div class="h-300-px">
              <canvas id="categoryPieChart"></canvas>
            </div>
          </div>
        </div>
      </div>



      <!-- Bar Chart: Recordings by Region -->
      <div class="w-full px-3 lg:w-1/2 lg:flex-none">
        <div class="relative flex flex-col h-full min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="p-4 pb-0 rounded-t-4">
            <h6 class="mb-1 dark:text-white">Recordings by Region</h6>
            <p class="text-sm leading-normal dark:text-white dark:opacity-60">Number of recordings (Noise + Clean Speech) collected in each region</p>
          </div>
          <div class="flex-auto p-4">
            <div style="height: 500px;">
              <canvas style="height: 100%; width: 100%;" id="regionBarChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- row 3 - Additional Charts -->
    <div class="flex flex-wrap mt-6 -mx-3">
      <!-- Line Chart: Recordings Over Time -->
      <div class="w-full px-3 mb-6 lg:mb-0 lg:w-2/3 lg:flex-none">
        <div class="relative flex flex-col h-full min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="p-4 pb-0 rounded-t-4">
            <h6 class="mb-1 dark:text-white">Recordings Over Time</h6>
            <p class="text-sm leading-normal dark:text-white dark:opacity-60">Monthly progression of recordings (Noise + Clean Speech)</p>
          </div>
          <div class="flex-auto p-4">
            <div style="height: 350px;" >
              <canvas style="height: 100%; width: 100%;" id="timeLineChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Radar Chart: Audio Features Analysis -->
      <div class="w-full px-3 lg:w-1/3 lg:flex-none">
        <div class="relative flex flex-col h-full min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="p-4 pb-0 rounded-t-4">
            <h6 class="mb-1 dark:text-white">Audio Features Analysis</h6>
            <p class="text-sm leading-normal dark:text-white dark:opacity-60">Average values of key audio features (Noise + Clean Speech)</p>
          </div>
          <div class="flex-auto p-4">
            <div class="h-300-px">
              <canvas id="audioRadarChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- row 4 - Duration Charts -->
    <div class="flex flex-wrap mt-6 -mx-3">
      <!-- Bar Chart: Duration by Region -->
      <div class="w-full px-3 mb-6 lg:mb-0 lg:w-1/2 lg:flex-none">
        <div class="relative flex flex-col h-full min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="p-4 pb-0 rounded-t-4">
            <h6 class="mb-1 dark:text-white">Duration by Region</h6>
            <p class="text-sm leading-normal dark:text-white dark:opacity-60">Total hours of audio (Noise + Clean Speech) per region</p>
          </div>
          <div class="flex-auto p-4">
            <div style="height: 500px;" class="h-300-px">
              <canvas style="height: 100%; width: 100%;" id="durationRegionChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Pie Chart: Duration Distribution -->
      <div class="w-full px-3 lg:w-1/2 lg:flex-none">
        <div class="relative flex flex-col h-full min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="p-4 pb-0 rounded-t-4">
            <h6 class="mb-1 dark:text-white">Duration Distribution</h6>
            <p class="text-sm leading-normal dark:text-white dark:opacity-60">Proportion of audio duration (Noise + Clean Speech) across regions</p>
          </div>
          <div class="flex-auto p-4">
            <div style="height: 500px;">
              <canvas id="durationPieChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="flex flex-wrap mt-6 -mx-3">
      <div class="w-full px-3">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="p-4 pb-0 rounded-t-4">
            <div class="flex flex-wrap items-center">
              <div class="flex items-center justify-center w-full px-3 lg:w-1/2 lg:flex-none">
                <h6 class="mb-1 dark:text-white">Recent Activity (Last 30 Minutes)</h6>
              </div>
              <div class="flex items-center justify-center w-full px-3 lg:w-1/2 lg:flex-none">
                <div class="flex">
                  <button id="liveChartPlay" class="px-3 py-1 mr-2 text-xs font-bold uppercase bg-blue-500 rounded-md text-white hover:bg-blue-600 transition-colors">
                    <i class="fas fa-play mr-1"></i> Play
                  </button>
                  <button id="liveChartPause" class="px-3 py-1 text-xs font-bold uppercase bg-gray-500 rounded-md text-white hover:bg-gray-600 transition-colors">
                    <i class="fas fa-pause mr-1"></i> Pause
                  </button>
                  <button id="liveChartReset" class="px-3 py-1 ml-2 text-xs font-bold uppercase bg-red-500 rounded-md text-white hover:bg-red-600 transition-colors">
                    <i class="fas fa-sync-alt mr-1"></i> Reset
                  </button>
                </div>
              </div>
            </div>
            <p class="text-sm leading-normal dark:text-white dark:opacity-60">Live updates of recent recording activity with decibel levels</p>
          </div>
          <div class="flex-auto p-4">
            <div class="h-300-px">
              <canvas id="liveLineChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js Script with Improved Live Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>

  <script>
    // Global state for current filter and unit
    let currentFilter = 'category';
    let durationUnit = 'seconds';
    // Function to fetch data from API
    async function fetchDashboardData() {
      try {
        const response = await fetch(`/dashboard/?filter_type=${currentFilter}&duration_unit=${durationUnit}`);
        if (!response.ok) {
          let bodyText = '';
          try {
            bodyText = await response.text();
          } catch (e) {
            bodyText = '';
          }
          console.error('Dashboard API request failed', {
            status: response.status,
            statusText: response.statusText,
            body: bodyText
          });
          throw new Error(`Network response was not ok (${response.status})`);
        }
        return await response.json();
      } catch (error) {
        console.error('Error fetching dashboard data:', error);
        // Show error message to user
        alert('Failed to load dashboard data. Please try again later.');
        return null;
      }
    }

    // Function to update the UI with the fetched data
    function updateDashboard(data) {
      if (!data) return;

      // Totals (all data)
      const totalAllDataEl = document.getElementById('totalAllData');
      if (totalAllDataEl) totalAllDataEl.textContent = data.basic_stats.total_all_data ?? 0;
      const userAllDataEl = document.getElementById('userAllData');
      if (userAllDataEl) userAllDataEl.textContent = data.basic_stats.user_all_data ?? 0;
      const totalAllDurEl = document.getElementById('totalAllDurationHours');
      if (totalAllDurEl) totalAllDurEl.textContent = data.basic_stats.total_all_duration_hours ?? 0;
      const avgAllDurEl = document.getElementById('averageAllDurationSeconds');
      if (avgAllDurEl) avgAllDurEl.textContent = data.basic_stats.avg_all_duration_seconds ?? 0;

      // Update basic stats
      // Noise-focused stats
      document.getElementById('totalRecordings').textContent = data.basic_stats.total_recordings;
      document.getElementById('userRecordings').textContent = data.basic_stats.user_recordings;
      document.getElementById('categoriesCount').textContent = data.basic_stats.categories_count;
      document.getElementById('classesCount').textContent = data.basic_stats.classes_count;
      document.getElementById('subClassesCount').textContent = data.basic_stats.sub_classes_count;
      document.getElementById('regionsCount').textContent = data.basic_stats.regions_count;
      document.getElementById('totalDurationHours').textContent = data.basic_stats.total_duration_hours;
      document.getElementById('averageDurationSeconds').textContent = data.basic_stats.avg_duration_seconds;
      // Clean speech cards (approved only)
      const cleanSpeechRecordingsEl = document.getElementById('cleanSpeechRecordings');
      if (cleanSpeechRecordingsEl) cleanSpeechRecordingsEl.textContent = data.basic_stats.clean_speech_recordings ?? 0;
      const userCleanSpeechEl = document.getElementById('userCleanSpeechRecordings');
      if (userCleanSpeechEl) userCleanSpeechEl.textContent = data.basic_stats.user_clean_speech_recordings ?? 0;
      const cleanSpeechDurEl = document.getElementById('cleanSpeechDurationHours');
      if (cleanSpeechDurEl) cleanSpeechDurEl.textContent = data.basic_stats.clean_speech_duration_hours ?? 0;
      const cleanSpeechAvgEl = document.getElementById('cleanSpeechAverageDurationSeconds');
      if (cleanSpeechAvgEl) cleanSpeechAvgEl.textContent = data.basic_stats.clean_speech_avg_duration_seconds ?? 0;

      // Persist current filter/unit
      currentFilter = data.current_filter || currentFilter;
      durationUnit = data.current_unit || durationUnit;

      // Update unit select visual state
      updateUnitSelect(durationUnit);

      // Update average parameters table
      updateAverageParametersTable(data.average_parameters, data.current_filter, data.current_unit);

      // Update class hours cards
      const classHoursContainer = document.getElementById('classHoursContainer');
      classHoursContainer.innerHTML = '';

      if (data.class_hours && data.class_hours.length > 0) {
        data.class_hours.forEach(item => {
          const cardHtml = `
            <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 xl:w-1/4 sm:flex-none">
              <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
                <div class="flex-auto p-4">
                  <div class="flex flex-row -mx-3">
                    <div class="flex-none w-2/3 max-w-full px-3">
                      <div>
                        <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Hours - ${item.label}</p>
                        <h5 class="mb-2 mt-4 font-bold dark:text-white">${item.hours}</h5>
                        <p class="mb-0 text-xs text-slate-500 dark:text-white/60">
                          <span class="font-bold">Total audio hours</span>
                        </p>
                      </div>
                    </div>
                    <div class="px-3 text-right basis-1/3">
                      <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-purple-500 to-indigo-500">
                        <i class="ni leading-none ni-collection text-lg relative top-3.5 text-white"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          classHoursContainer.innerHTML += cardHtml;
        });
      }

      // Initialize charts with the data
      initCharts(data.charts);
    }

    // Function to initialize all charts
    function initCharts(chartData) {
      // Colors for dark/light mode compatibility
      const textColor = window.matchMedia('(prefers-color-scheme: dark)').matches ? '#fff' : '#000';
      const gridColor = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

      // Category Pie Chart
      const categoryCtx = document.getElementById('categoryPieChart').getContext('2d');
      const categoryPieChart = new Chart(categoryCtx, {
        type: 'pie',
        data: {
          labels: chartData.category.labels,
          datasets: [{
            data: chartData.category.data,
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)',
              'rgba(153, 102, 255, 0.7)',
              'rgba(255, 159, 64, 0.7)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)',
              'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: textColor
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      // Region Bar Chart
      const regionCtx = document.getElementById('regionBarChart').getContext('2d');
      const regionBarChart = new Chart(regionCtx, {
        type: 'bar',
        data: {
          labels: chartData.region.labels,
          datasets: [{
            label: 'Recordings',
            data: chartData.region.data,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: gridColor
              },
              ticks: {
                color: textColor
              }
            },
            x: {
              grid: {
                color: gridColor
              },
              ticks: {
                color: textColor
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: textColor
              }
            }
          }
        }
      });

      // Time Line Chart
      const timeCtx = document.getElementById('timeLineChart').getContext('2d');
      const timeLineChart = new Chart(timeCtx, {
        type: 'line',
        data: {
          labels: chartData.time_series.labels,
          datasets: [{
            label: 'Recordings',
            data: chartData.time_series.data,
            fill: false,
            backgroundColor: 'rgba(75, 192, 192, 0.7)',
            borderColor: 'rgba(75, 192, 192, 1)',
            tension: 0.1,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: gridColor
              },
              ticks: {
                color: textColor
              }
            },
            x: {
              grid: {
                color: gridColor
              },
              ticks: {
                color: textColor
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: textColor
              }
            }
          }
        }
      });

      // Audio Radar Chart
      const radarCtx = document.getElementById('audioRadarChart').getContext('2d');
      const audioRadarChart = new Chart(radarCtx, {
        type: 'radar',
        data: {
          labels: ['RMS Energy', 'Spectral Centroid', 'Spectral Bandwidth', 'Zero Crossing', 'Spectral Rolloff', 'Duration (s)'],
          datasets: [{
            label: 'Average Values',
            data: chartData.audio_features,
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            borderColor: 'rgba(153, 102, 255, 1)',
            pointBackgroundColor: 'rgba(153, 102, 255, 1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: {
            r: {
              angleLines: {
                color: gridColor
              },
              grid: {
                color: gridColor
              },
              pointLabels: {
                color: textColor
              },
              ticks: {
                color: textColor,
                backdropColor: 'transparent'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: textColor
              }
            }
          }
        }
      });

      // Duration by Region Bar Chart
      const durationRegionCtx = document.getElementById('durationRegionChart').getContext('2d');
      const durationRegionChart = new Chart(durationRegionCtx, {
        type: 'bar',
        data: {
          labels: chartData.duration_region.labels,
          datasets: [{
            label: 'Hours',
            data: chartData.duration_region.data,
            backgroundColor: 'rgba(147, 51, 234, 0.7)',
            borderColor: 'rgba(147, 51, 234, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: gridColor
              },
              ticks: {
                color: textColor,
                callback: function(value) {
                  return value + ' hrs';
                }
              }
            },
            x: {
              grid: {
                color: gridColor
              },
              ticks: {
                color: textColor
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: textColor
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y + ' hours';
                }
              }
            }
          }
        }
      });

      // Duration Distribution Pie Chart
      const durationPieCtx = document.getElementById('durationPieChart').getContext('2d');
      const durationPieChart = new Chart(durationPieCtx, {
        type: 'pie',
        data: {
          labels: chartData.duration_region.labels,
          datasets: [{
            data: chartData.duration_region.data,
            backgroundColor: [
              'rgba(147, 51, 234, 0.7)',
              'rgba(59, 130, 246, 0.7)',
              'rgba(16, 185, 129, 0.7)',
              'rgba(245, 158, 11, 0.7)',
              'rgba(239, 68, 68, 0.7)',
              'rgba(168, 85, 247, 0.7)'
            ],
            borderColor: [
              'rgba(147, 51, 234, 1)',
              'rgba(59, 130, 246, 1)',
              'rgba(16, 185, 129, 1)',
              'rgba(245, 158, 11, 1)',
              'rgba(239, 68, 68, 1)',
              'rgba(168, 85, 247, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: textColor
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} hrs (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      // Live Line Chart
      const liveCtx = document.getElementById('liveLineChart').getContext('2d');
      const initialData = [];
      const now = Date.now();
      for (let i = 4; i >= 0; i--) {
        initialData.push({
          x: now - (i * 60000), // 1 minute intervals
          y: Math.floor(Math.random() * 20) + 60 // Random dB between 60-80
        });
      }

      const liveLineChart = new Chart(liveCtx, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Decibel Level',
            data: initialData,
            backgroundColor: 'rgba(255, 99, 132, 0.5)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'realtime',
              realtime: {
                duration: 300000, // 5 minutes window
                refresh: 1000, // update every second
                delay: 4000,
                onRefresh: chart => {
                  if (isPlaying) {
                    chart.data.datasets.forEach(dataset => {
                      dataset.data.push({
                        x: Date.now(),
                        y: Math.floor(Math.random() * 25) + 55 // Random dB between 55-80
                      });
                    });
                  }
                }
              },
              grid: {
                color: gridColor
              },
              ticks: {
                color: textColor
              }
            },
            y: {
              min: 50,
              max: 90,
              grid: {
                color: gridColor
              },
              ticks: {
                color: textColor,
                callback: function(value) {
                  return value + ' dB';
                }
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: textColor
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y + ' dB';
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });

      // Live chart controls
      let isPlaying = true;
      document.getElementById('liveChartPlay').addEventListener('click', function() {
        if (!isPlaying) {
          isPlaying = true;
          this.classList.add('bg-blue-600');
          document.getElementById('liveChartPause').classList.remove('bg-gray-600');
          document.getElementById('liveChartPause').classList.add('bg-gray-600');
        }
      });

      document.getElementById('liveChartPause').addEventListener('click', function() {
        if (isPlaying) {
          isPlaying = false;
          this.classList.add('bg-gray-600');
          document.getElementById('liveChartPlay').classList.remove('bg-blue-600');
          document.getElementById('liveChartPlay').classList.add('bg-blue-500');
        }
      });

      document.getElementById('liveChartReset').addEventListener('click', function() {
        liveLineChart.data.datasets[0].data = [];
        liveLineChart.update();
      });

      document.getElementById('liveChartPlay').classList.add('bg-blue-600');
    }

    // Function to update average parameters table
    function updateAverageParametersTable(data, currentFilter, unit) {
      const tableBody = document.getElementById('averageParametersTableBody');
      tableBody.innerHTML = '';

      if (!data || data.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="4" class="p-4 text-center text-slate-500 dark:text-white/60">
              No data available
            </td>
          </tr>
        `;
        return;
      }

      // Update header units
      const avgUnitEl = document.getElementById('avgDurationHeaderUnit');
      const totalUnitEl = document.getElementById('totalDurationHeaderUnit');
      const unitLabel = (unit === 'hours') ? 'hrs' : 's';
      if (avgUnitEl) avgUnitEl.textContent = unitLabel;
      if (totalUnitEl) totalUnitEl.textContent = unitLabel;

      data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.className = index === data.length - 1
          ? 'p-2 align-middle bg-transparent border-b-0 whitespace-nowrap shadow-transparent'
          : 'p-2 align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent';

        row.innerHTML = `
          <td class="p-2 align-middle bg-transparent ${index === data.length - 1 ? 'border-b-0' : 'border-b dark:border-white/40'} whitespace-nowrap shadow-transparent">
            <div class="flex px-2 py-1">
              <div class="flex flex-col justify-center">
                <h6 class="mb-0 text-sm leading-normal dark:text-white">${item.name}</h6>
              </div>
            </div>
          </td>
          <td class="p-2 align-middle bg-transparent ${index === data.length - 1 ? 'border-b-0' : 'border-b dark:border-white/40'} whitespace-nowrap shadow-transparent">
            <p class="mb-0 text-sm font-semibold leading-tight dark:text-white dark:opacity-80">${item.avg_count}</p>
          </td>
          <td class="p-2 align-middle bg-transparent ${index === data.length - 1 ? 'border-b-0' : 'border-b dark:border-white/40'} whitespace-nowrap shadow-transparent">
            <p class="mb-0 text-sm font-semibold leading-tight dark:text-white dark:opacity-80">${item.avg_duration}</p>
          </td>
          <td class="p-2 align-middle bg-transparent ${index === data.length - 1 ? 'border-b-0' : 'border-b dark:border-white/40'} whitespace-nowrap shadow-transparent">
            <p class="mb-0 text-sm font-semibold leading-tight dark:text-white dark:opacity-80">${item.total_duration}</p>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Function to show table loading skeleton
    function showTableLoading() {
      console.log('=== SHOWING TABLE LOADING ===');
      document.getElementById('tableLoadingSkeleton').classList.remove('hidden');
      document.getElementById('tableContent').classList.add('hidden');
    }

    // Function to hide table loading skeleton
    function hideTableLoading() {
      console.log('=== HIDING TABLE LOADING ===');
      document.getElementById('tableLoadingSkeleton').classList.add('hidden');
      document.getElementById('tableContent').classList.remove('hidden');
    }

    // Function to update filter button states
    function updateFilterButtons(activeFilter) {
      const buttons = document.querySelectorAll('.filter-btn');
      buttons.forEach(button => {
        const filter = button.getAttribute('data-filter');
        if (filter === activeFilter) {
          button.classList.remove('bg-transparent', 'text-primary', 'border-primary');
          button.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
        } else {
          button.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
          button.classList.add('bg-transparent', 'text-primary', 'border-primary');
        }
      });
    }

    // Global function to handle filter clicks (called by inline onclick)
    function handleFilterClick(filterType) {
      console.log('=== HANDLE FILTER CLICK ===', filterType);
      currentFilter = filterType;
      fetchFilteredData(filterType);
    }

    // Function to fetch filtered data
    async function fetchFilteredData(filterType) {
      try {
        console.log('=== FETCHING FILTERED DATA ===', filterType);
        showTableLoading();
        const url = `/dashboard/?filter_type=${filterType}&duration_unit=${durationUnit}`;
        console.log('Making request to:', url);
        const response = await fetch(url);
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();
        console.log('Received data:', data);
        updateAverageParametersTable(data.average_parameters, data.current_filter, data.current_unit);
        updateFilterButtons(data.current_filter);
        updateUnitSelect(data.current_unit);
        hideTableLoading();
      } catch (error) {
        console.error('Error fetching filtered data:', error);
        hideTableLoading();
        alert('Failed to load filtered data. Please try again later.');
      }
    }

    // Add event listeners for filter buttons
    function setupFilterButtons() {
      console.log('=== SETTING UP FILTER BUTTONS ===');
      const filterButtons = document.querySelectorAll('.filter-btn');
      console.log('Found buttons:', filterButtons.length);

      if (filterButtons.length === 0) {
        console.error('No filter buttons found!');
        return;
      }

      filterButtons.forEach((button, index) => {
        console.log(`Setting up button ${index}:`, button.id, button.getAttribute('data-filter'));
        button.addEventListener('click', function(e) {
          console.log('=== BUTTON CLICKED ===');
          e.preventDefault();
          const filterType = this.getAttribute('data-filter');
          console.log('Filter type:', filterType);

          // Add visual feedback
          this.style.transform = 'scale(0.95)';
          setTimeout(() => {
            this.style.transform = 'scale(1)';
          }, 150);

          console.log('Calling fetchFilteredData...');
          fetchFilteredData(filterType);
        });
      });
      console.log('=== FILTER BUTTONS SETUP COMPLETE ===');
    }

    // Unit select state updater
    function updateUnitSelect(activeUnit) {
      const sel = document.getElementById('unit-select');
      if (sel) sel.value = activeUnit;
    }

    // Setup unit select change handler
    function setupUnitSelect() {
      const sel = document.getElementById('unit-select');
      if (!sel) return;
      sel.addEventListener('change', function() {
        console.log('=== UNIT SELECT CHANGED ===', this.value);
        const val = this.value === 'hours' ? 'hours' : 'seconds';
        durationUnit = val;
        updateUnitSelect(durationUnit);
        fetchFilteredData(currentFilter);
      });
    }

    // Event delegation fallback
    function setupEventDelegation() {
      console.log('=== SETTING UP EVENT DELEGATION ===');
      document.addEventListener('click', function(e) {
        console.log('Document clicked, target:', e.target);
        if (e.target.classList.contains('filter-btn')) {
          console.log('=== EVENT DELEGATION: BUTTON CLICKED ===');
          e.preventDefault();
          const filterType = e.target.getAttribute('data-filter');
          console.log('Event delegation filter type:', filterType);

          // Add visual feedback
          e.target.style.transform = 'scale(0.95)';
          setTimeout(() => {
            e.target.style.transform = 'scale(1)';
          }, 150);

          fetchFilteredData(filterType);
        }
      });
      // Fallback for unit select changes
      document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'unit-select') {
          const val = e.target.value === 'hours' ? 'hours' : 'seconds';
          console.log('=== EVENT DELEGATION: UNIT CHANGE ===', val);
          durationUnit = val;
          updateUnitSelect(durationUnit);
          fetchFilteredData(currentFilter);
        }
      });
      console.log('=== EVENT DELEGATION SETUP COMPLETE ===');
    }

    // Main function to load and initialize the dashboard
    async function initDashboard() {
      // Show loading skeleton
      document.getElementById('loadingSkeleton').classList.remove('hidden');
      document.getElementById('dashboardContent').classList.add('hidden');

      // Fetch data from API
      const data = await fetchDashboardData();

      if (data) {
        // Hide loading skeleton and show content
        document.getElementById('loadingSkeleton').classList.add('hidden');
        document.getElementById('dashboardContent').classList.remove('hidden');

        // Update the UI with the fetched data
        updateDashboard(data);

        // Setup filter buttons after initial load
        console.log('=== INITIALIZING FILTER BUTTONS ===');
        // Add a small delay to ensure DOM is fully rendered
        setTimeout(() => {
          console.log('Setting up filter buttons after delay...');
          setupFilterButtons();
          updateUnitSelect(durationUnit);
          setupUnitSelect();
        }, 100);

        // Also set up event delegation as a fallback
        console.log('Setting up event delegation...');
        setupEventDelegation();
      }
    }

    // Initialize the dashboard when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== DOM CONTENT LOADED ===');
      initDashboard();
      // Ensure unit select is wired even before data returns
      setupUnitSelect();
    });

    // Also try immediate setup as a test
    console.log('=== SCRIPT LOADED ===');
    setTimeout(() => {
      console.log('=== TESTING IMMEDIATE SETUP ===');
      const testButtons = document.querySelectorAll('.filter-btn');
      console.log('Immediate test - found buttons:', testButtons.length);
    }, 1000);
  </script>
{% endblock %}
