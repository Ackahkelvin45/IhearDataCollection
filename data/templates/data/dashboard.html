{% extends 'datacollection/layout.html'%}

{% block content %}
  <nav>
    <!-- breadcrumb -->
    <ol style="margin-bottom: 30px;" class="flex flex-wrap pt-1 mr-12 bg-transparent rounded-lg sm:mr-16">
      <li class="text-sm leading-normal">
        <a class="text-white opacity-50" href="javascript:;">Pages</a>
      </li>
      <li class="text-sm pl-2 capitalize leading-normal text-white before:float-left before:pr-2 before:text-white before:content-['/']" aria-current="page">Dashboard</li>
    </ol>
    <h6 class="mb-0 font-bold text-white capitalize">Dashboard</h6>
  </nav>

  <!-- row 1 - Stats Cards -->
  <div class="flex flex-wrap -mx-3">
    <!-- Card 1: Total Recordings -->
    <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
      <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
        <div class="flex-auto p-4">
          <div class="flex flex-row -mx-3">
            <div class="flex-none w-2/3 max-w-full px-3">
              <div>
                <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Total Recordings</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white">{{ total_recordings }}</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60">
                  <span class="font-bold">All users</span>
                </p>
              </div>
            </div>
            <div class="px-3 text-right basis-1/3">
              <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-blue-500 to-violet-500">
                <i class="ni leading-none ni-sound-wave text-lg relative top-3.5 text-white"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 2: Your Recordings -->
    <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
      <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
        <div class="flex-auto p-4">
          <div class="flex flex-row -mx-3">
            <div class="flex-none w-2/3 max-w-full px-3">
              <div>
                <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Your Recordings</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white">{{ user_recordings }}</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60">
                  <span class="font-bold">Your contributions</span>
                </p>
              </div>
            </div>
            <div class="px-3 text-right basis-1/3">
              <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-emerald-500 to-teal-400">
                <i class="ni leading-none ni-single-02 text-lg relative top-3.5 text-white"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 3: Categories -->
    <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
      <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
        <div class="flex-auto p-4">
          <div class="flex flex-row -mx-3">
            <div class="flex-none w-2/3 max-w-full px-3">
              <div>
                <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Categories</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white">{{ categories_count }}</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60">
                  <span class="font-bold">Different types</span>
                </p>
              </div>
            </div>
            <div class="px-3 text-right basis-1/3">
              <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-orange-500 to-yellow-500">
                <i class="ni leading-none ni-bullet-list-67 text-lg relative top-3.5 text-white"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 4: Regions -->
    <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
      <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
        <div class="flex-auto p-4">
          <div class="flex flex-row -mx-3">
            <div class="flex-none w-2/3 max-w-full px-3">
              <div>
                <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Regions</p>
                <h5 class="mb-2 mt-4 font-bold dark:text-white">{{ regions_count }}</h5>
                <p class="mb-0 text-xs text-slate-500 dark:text-white/60">
                  <span class="font-bold">Covered areas</span>
                </p>
              </div>
            </div>
            <div class="px-3 text-right basis-1/3">
              <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-red-500 to-pink-500">
                <i class="ni leading-none ni-map-big text-lg relative top-3.5 text-white"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- row 2 - Main Charts -->
  <div class="flex flex-wrap mt-6 -mx-3">
    <!-- Pie Chart: Recordings by Category -->
    <div class="w-full px-3 mb-6 lg:mb-0 lg:w-1/2 lg:flex-none">
      <div class="relative flex flex-col h-full min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
        <div class="p-4 pb-0 rounded-t-4">
          <h6 class="mb-1 dark:text-white">Recordings by Category</h6>
          <p class="text-sm leading-normal dark:text-white dark:opacity-60">Distribution of recordings across different categories</p>
        </div>
        <div class="flex-auto p-4">
          <div class="h-300-px">
            <canvas id="categoryPieChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Bar Chart: Recordings by Region -->
    <div class="w-full px-3 lg:w-1/2 lg:flex-none">
      <div class="relative flex flex-col h-full min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
        <div class="p-4 pb-0 rounded-t-4">
          <h6 class="mb-1 dark:text-white">Recordings by Region</h6>
          <p class="text-sm leading-normal dark:text-white dark:opacity-60">Number of recordings collected in each region</p>
        </div>
        <div class="flex-auto p-4">
          <div class="h-300-px">
            <canvas id="regionBarChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- row 3 - Additional Charts -->
  <div class="flex flex-wrap mt-6 -mx-3">
    <!-- Line Chart: Recordings Over Time -->
    <div class="w-full px-3 mb-6 lg:mb-0 lg:w-2/3 lg:flex-none">
      <div class="relative flex flex-col h-full min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
        <div class="p-4 pb-0 rounded-t-4">
          <h6 class="mb-1 dark:text-white">Recordings Over Time</h6>
          <p class="text-sm leading-normal dark:text-white dark:opacity-60">Monthly progression of recordings collected</p>
        </div>
        <div class="flex-auto p-4">
          <div class="h-300-px">
            <canvas id="timeLineChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Radar Chart: Audio Features Analysis -->
    <div class="w-full px-3 lg:w-1/3 lg:flex-none">
      <div class="relative flex flex-col h-full min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
        <div class="p-4 pb-0 rounded-t-4">
          <h6 class="mb-1 dark:text-white">Audio Features Analysis</h6>
          <p class="text-sm leading-normal dark:text-white dark:opacity-60">Average values of key audio features</p>
        </div>
        <div class="flex-auto p-4">
          <div class="h-300-px">
            <canvas id="audioRadarChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="flex flex-wrap mt-6 -mx-3">
    <div class="w-full px-3">
      <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
        <div class="p-4 pb-0 rounded-t-4">
          <div class="flex flex-wrap items-center">
            <div class="flex items-center justify-center w-full px-3 lg:w-1/2 lg:flex-none">
              <h6 class="mb-1 dark:text-white">Recent Activity (Last 30 Minutes)</h6>
            </div>
            <div class="flex items-center justify-center w-full px-3 lg:w-1/2 lg:flex-none">
              <div class="flex">
                <button id="liveChartPlay" class="px-3 py-1 mr-2 text-xs font-bold uppercase bg-blue-500 rounded-md text-white hover:bg-blue-600 transition-colors">
                  <i class="fas fa-play mr-1"></i> Play
                </button>
                <button id="liveChartPause" class="px-3 py-1 text-xs font-bold uppercase bg-gray-500 rounded-md text-white hover:bg-gray-600 transition-colors">
                  <i class="fas fa-pause mr-1"></i> Pause
                </button>
                <button id="liveChartReset" class="px-3 py-1 ml-2 text-xs font-bold uppercase bg-red-500 rounded-md text-white hover:bg-red-600 transition-colors">
                  <i class="fas fa-sync-alt mr-1"></i> Reset
                </button>
              </div>
            </div>
          </div>
          <p class="text-sm leading-normal dark:text-white dark:opacity-60">Live updates of recent recording activity with decibel levels</p>
        </div>
        <div class="flex-auto p-4">
          <div class="h-300-px">
            <canvas id="liveLineChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js Script with Improved Live Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>

  <!-- Chart.js Script -->
  <script>
    // Colors for dark/light mode compatibility
    const textColor = window.matchMedia('(prefers-color-scheme: dark)').matches ? '#fff' : '#000';
    const gridColor = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    
    // Category Pie Chart
    const categoryCtx = document.getElementById('categoryPieChart').getContext('2d');
    const categoryPieChart = new Chart(categoryCtx, {
      type: 'pie',
      data: {
        labels: {{ category_labels|safe }},
        datasets: [{
          data: {{ category_data|safe }},
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)'
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              color: textColor
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });

    // Region Bar Chart
    const regionCtx = document.getElementById('regionBarChart').getContext('2d');
    const regionBarChart = new Chart(regionCtx, {
      type: 'bar',
      data: {
        labels: {{ region_labels|safe }},
        datasets: [{
          label: 'Recordings',
          data: {{ region_data|safe }},
          backgroundColor: 'rgba(54, 162, 235, 0.7)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: gridColor
            },
            ticks: {
              color: textColor
            }
          },
          x: {
            grid: {
              color: gridColor
            },
            ticks: {
              color: textColor
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: textColor
            }
          }
        }
      }
    });

    // Time Line Chart
    const timeCtx = document.getElementById('timeLineChart').getContext('2d');
    const timeLineChart = new Chart(timeCtx, {
      type: 'line',
      data: {
        labels: {{ time_labels|safe }},
        datasets: [{
          label: 'Recordings',
          data: {{ time_data|safe }},
          fill: false,
          backgroundColor: 'rgba(75, 192, 192, 0.7)',
          borderColor: 'rgba(75, 192, 192, 1)',
          tension: 0.1,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: gridColor
            },
            ticks: {
              color: textColor
            }
          },
          x: {
            grid: {
              color: gridColor
            },
            ticks: {
              color: textColor
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: textColor
            }
          }
        }
      }
    });

    // Audio Radar Chart
    const radarCtx = document.getElementById('audioRadarChart').getContext('2d');
    const audioRadarChart = new Chart(radarCtx, {
      type: 'radar',
      data: {
        labels: ['RMS Energy', 'Spectral Centroid', 'Spectral Bandwidth', 'Zero Crossing', 'Harmonic Ratio', 'Percussive Ratio'],
        datasets: [{
          label: 'Average Values',
          data: {{ audio_features_data|safe }},
          backgroundColor: 'rgba(153, 102, 255, 0.2)',
          borderColor: 'rgba(153, 102, 255, 1)',
          pointBackgroundColor: 'rgba(153, 102, 255, 1)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgba(153, 102, 255, 1)',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        scales: {
          r: {
            angleLines: {
              color: gridColor
            },
            grid: {
              color: gridColor
            },
            pointLabels: {
              color: textColor
            },
            ticks: {
              color: textColor,
              backdropColor: 'transparent'
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: textColor
            }
          }
        }
      }
    });

        const liveCtx = document.getElementById('liveLineChart').getContext('2d');

    // Generate initial data points for the last 5 minutes
    const initialData = [];
    const now = Date.now();
    for (let i = 4; i >= 0; i--) {
      initialData.push({
        x: now - (i * 60000), // 1 minute intervals
        y: Math.floor(Math.random() * 20) + 60 // Random dB between 60-80
      });
    }

    const liveLineChart = new Chart(liveCtx, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Decibel Level',
          data: initialData,
          backgroundColor: 'rgba(255, 99, 132, 0.5)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: false,
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'realtime',
            realtime: {
              duration: 300000, // 5 minutes window
              refresh: 1000, // update every second
              delay: 4000,
              onRefresh: chart => {
                if (isPlaying) {
                  chart.data.datasets.forEach(dataset => {
                    dataset.data.push({
                      x: Date.now(),
                      y: Math.floor(Math.random() * 25) + 55 // Random dB between 55-80
                    });
                  });
                }
              }
            },
            grid: {
              color: gridColor
            },
            ticks: {
              color: textColor
            }
          },
          y: {
            min: 50,
            max: 90,
            grid: {
              color: gridColor
            },
            ticks: {
              color: textColor,
              callback: function(value) {
                return value + ' dB';
              }
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: textColor
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y + ' dB';
              }
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    });

    // Improved Play/Pause functionality
    let isPlaying = true;
    let updateInterval;
    
    // Play button
    document.getElementById('liveChartPlay').addEventListener('click', function() {
      if (!isPlaying) {
        isPlaying = true;
        this.classList.add('bg-blue-600');
        document.getElementById('liveChartPause').classList.remove('bg-gray-600');
        document.getElementById('liveChartPause').classList.add('bg-gray-600');
      }
    });
    
    // Pause button
    document.getElementById('liveChartPause').addEventListener('click', function() {
      if (isPlaying) {
        isPlaying = false;
        this.classList.add('bg-gray-600');
        document.getElementById('liveChartPlay').classList.remove('bg-blue-600');
        document.getElementById('liveChartPlay').classList.add('bg-blue-500');
      }
    });
    
    // Reset button
    document.getElementById('liveChartReset').addEventListener('click', function() {
      liveLineChart.data.datasets[0].data = [];
      liveLineChart.update();
    });

    // Initial state
    document.getElementById('liveChartPlay').classList.add('bg-blue-600');
  </script>
{% endblock %}