{% extends 'datacollection/layout.html' %}
{% load static %}

{% block content %}
<nav>
  <ol style="margin-bottom: 30px;" class="flex flex-wrap pt-1 mr-12 bg-transparent rounded-lg sm:mr-16">
    <li class="text-sm leading-normal">
      <a class="text-white opacity-50" href="{% url 'insights:home' %}">home</a>
    </li>
    <li class="text-sm pl-2 capitalize leading-normal text-white before:float-left before:pr-2 before:text-white before:content-['/']" aria-current="page">Data Insights</li>
  </ol>
  </nav>

<div class="flex flex-wrap -mx-3">
  <div class="w-full px-6 py-6 mx-auto">
    <div class="relative flex flex-col min-w-0 mb-6 break-words bg-white border-0 shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border p-6 md:p-10" style="background:#fff;border-radius:16px;box-shadow:0 10px 24px rgba(2,55,50,0.08);padding:28px;">
<div class="flex gap-6" style="display:flex;gap:24px;align-items:flex-start;">
  <!-- Left rail: Recents -->
  <aside class="hidden lg:block w-64 bg-white shadow rounded-2xl p-4 h-[75vh] overflow-y-auto" style="min-width:260px;width:260px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;box-shadow:0 6px 16px rgba(2,55,50,0.06);height:72vh;">
    <div class="flex items-center justify-between mb-2">
      <h5 class="font-semibold text-slate-700">Data Insights</h5>
      <a href="{% url 'insights:home' %}" class="text-xs text-primary">All Chats</a>
    </div>
    <ul class="space-y-2">
      {% for item in recents %}
      <li>
        <a class="block px-3 py-2 rounded-lg hover:bg-primary-light text-slate-700" href="#">{{ item }}</a>
      </li>
      {% endfor %}
    </ul>
  </aside>

  <!-- Main chat area -->
  <section class="flex-1" style="min-width:0;">
    <div class="flex items-center justify-between mb-4" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <div class="flex items-center gap-2">
        <h2 class="text-xl font-semibold text-slate-800" style="font-weight:700;color:#0f172a;font-size:22px;">Show me recent data collected </h2>
        <div class="relative">
          <button id="chatMenuBtn" class="px-2 py-1 text-slate-600 hover:text-primary"><i class="fa-solid fa-chevron-down"></i></button>
          <div id="chatMenu" class="hidden absolute mt-2 w-40 bg-white border rounded-md shadow-lg z-10">
            <button data-action="rename" class="w-full text-left px-3 py-2 text-sm hover:bg-secondary-light">Rename</button>
            <button data-action="delete" class="w-full text-left px-3 py-2 text-sm hover:bg-secondary-light">Delete</button>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        {% if query %}
        <span style="background:#e6f7f1;color:#065f46;padding:10px 14px;border-radius:9999px;border:1px solid #c7efe0;white-space:nowrap;">{{ query }}</span>
        {% endif %}
        <a href="{% url 'insights:home' %}" class="inline-flex items-center px-3 py-2 rounded-md text-white bg-primary hover:opacity-90" style="background:var(--primary-color);color:#fff;border-radius:10px;padding:10px 14px;box-shadow:0 4px 10px rgba(2,55,50,0.08);">
        <i class="fa-regular fa-message mr-2"></i>
        new chat
        </a>
      </div>
    </div>

    <!-- User query bubble -->


    <!-- Chat bubbles: user (left), assistant (right) -->
    <div style="margin-bottom:16px;display:flex;gap:12px;align-items:flex-start;">
      <div style="max-width:60%;background:rgba(0,213,83,0.1);color:#334155;padding:12px 14px;border-radius:14px 14px 4px 14px;">{{ query }}</div>
      <div style="flex:1;"></div>
    </div>

    <div style="margin-bottom:16px;display:flex;gap:12px;align-items:flex-start;">
      <div style="flex:1;"></div>
      <div style="max-width:60%;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px 14px;box-shadow:0 6px 16px rgba(2,55,50,0.06);">{{ assistant_text|default:"Here is what I found based on your request." }}</div>
    </div>

    <!-- Assistant response area: either a chart OR a table, never both -->
    <div class="bg-white shadow rounded-2xl p-6 mb-6" style="background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 16px rgba(2,55,50,0.06);">
      <p class="text-slate-700 mb-4" style="margin-bottom:14px;color:#334155;">{{ subtitle|default:'Results' }}</p>

      {% if show_chart and chart %}
      {{ chart|json_script:"chart-data" }}
      <div class="flex justify-center" style="display:flex;justify-content:center;">
        <div style="max-width:680px;width:100%;">
          <canvas id="insightsChart" style="width:100%;height:380px;"></canvas>
        </div>
      </div>
      {% endif %}

      {% if show_table %}
      <div style="border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;background:#fff;box-shadow:0 6px 16px rgba(2,55,50,0.04);">
        <table style="width:100%;border-collapse:separate;border-spacing:0;">
          <thead style="background:#f8fafc;">
            <tr>
              {% for h in table_headers %}
              <th style="text-align:left;padding:12px 16px;color:#334155;font-weight:600;font-size:14px;">{{ h }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in table_rows %}
            <tr style="border-top:1px solid #e5e7eb;">
              {% for col in row %}
              <td style="padding:14px 16px;">{{ col }}</td>
              {% endfor %}
            </tr>
            {% empty %}
            <tr><td style="padding:14px 16px;color:#64748b;">No data</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <div class="mt-4 flex items-center gap-3 text-slate-500" style="margin-top:12px;display:flex;gap:12px;color:#64748b;">
        <button class="hover:text-primary"><i class="fa-regular fa-copy"></i></button>
        <button class="hover:text-primary"><i class="fa-regular fa-bookmark"></i></button>
        <button class="hover:text-primary"><i class="fa-solid fa-download"></i></button>
      </div>
    </div>

    <!-- Composer -->
    <form action="{% url 'insights:session' %}" method="get" class="mt-6">
      <div class="relative" style="position:relative;">
        <input name="q" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-full py-4 md:py-5 pl-4 pr-16 outline-none text-slate-700 focus:ring-2 focus:ring-secondary/30 focus:border-secondary" style="width:100%;background:#f8fafc;border:1px solid #e5e7eb;border-radius:9999px;padding:16px 56px 16px 16px;" placeholder="Ask anything about your customers" />
        <button class="absolute right-2 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-secondary text-white flex items-center justify-center hover:opacity-90" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:48px;height:48px;border-radius:9999px;background:var(--secondary-color);color:#fff;" aria-label="Send">
          <i class="fa-solid fa-microphone"></i>
        </button>
      </div>
    </form>
  </section>

</div>
    </div>
  </div>
</div>

<!-- Rename modal -->
<div id="renameModal" class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center">
  <div class="bg-white w-full max-w-md mx-4 rounded-xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-semibold text-slate-800">Rename Chat</h3>
      <button id="closeRename" class="text-slate-400"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <form>
      <input type="text" class="w-full border rounded-md px-3 py-2 mb-4" placeholder="List of Dormant Accounts"/>
      <div class="flex justify-end gap-2">
        <button type="button" id="cancelRename" class="px-4 py-2 rounded-md bg-slate-100">Cancel</button>
        <button type="button" class="px-4 py-2 rounded-md text-white bg-primary">Save</button>
      </div>
    </form>
  </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // dropdown
  const btn = document.getElementById('chatMenuBtn');
  const menu = document.getElementById('chatMenu');
  btn.addEventListener('click', () => menu.classList.toggle('hidden'));

  // modal
  const renameModal = document.getElementById('renameModal');
  menu.querySelector('[data-action="rename"]').addEventListener('click', () => {
    renameModal.classList.remove('hidden');
    renameModal.classList.add('flex');
    menu.classList.add('hidden');
  });
  document.getElementById('closeRename').onclick = () => renameModal.classList.add('hidden');
  document.getElementById('cancelRename').onclick = () => renameModal.classList.add('hidden');

  // chart
  (function(){
    const dataEl = document.getElementById('chart-data');
    if (!dataEl) return;
    const chartPayload = JSON.parse(dataEl.textContent);
    const canvas = document.getElementById('insightsChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const isBar = chartPayload.type === 'bar';
    new Chart(ctx, {
      type: chartPayload.type || 'doughnut',
      data: {
        labels: chartPayload.labels || [],
        datasets: [{
          data: chartPayload.values || [],
          backgroundColor: ['#22c55e','#38bdf8','#a78bfa','#f59e0b','#ef4444','#0ea5e9','#6ee7b7','#fca5a5'],
          borderWidth: 0,
        }]
      },
      options: Object.assign({}, isBar ? { scales: { y: { beginAtZero: true } } } : { cutout: '60%' }, { plugins: { legend: { position: 'right' } } })
    });
  })();
</script>
{% endblock %}
