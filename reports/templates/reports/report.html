{% extends 'datacollection/layout.html'%}

{% block content %}
<style>
  /* Skeleton cell style */
.skeleton-cell {
  height: 20px;              /* adjust height to match your table row text */
  border-radius: 0.375rem;   /* rounded corners */
  background-color: #e5e7eb; /* Tailwind gray-300 */
  width: 100%;               /* full width of cell */
}

/* Variant widths for variety */
.skeleton-cell.short { width: 40%; }
.skeleton-cell.medium { width: 60%; }
.skeleton-cell.long { width: 80%; }
/* Custom pulse shimmer */
@keyframes pulse-shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0
  }
}

.skeleton-cell {
  height: 20px;
  border-radius: 0.375rem;   /* rounded-md */
  width: 100%;
  background: linear-gradient(
    90deg,
    #e5e7eb 25%,
    #f3f4f6 50%,
    #e5e7eb 75%
  ); /* Tailwind gray-300 / gray-100 shimmer */
  background-size: 200% 100%;
  animation: pulse-shimmer 1.5s ease-in-out infinite;
}

/* Variants for text-like widths */
.skeleton-cell.short { width: 40%; }
.skeleton-cell.medium { width: 60%; }
.skeleton-cell.long { width: 80%; }

  </style>
  <nav>
    <!-- breadcrumb -->
    <ol style="margin-bottom: 30px;" class="flex flex-wrap pt-1 mr-12 bg-transparent rounded-lg sm:mr-16">
      <li class="text-sm leading-normal">
        <a class="text-white opacity-50" href="javascript:;">home</a>
      </li>
      <li class="text-sm pl-2 capitalize leading-normal text-white before:float-left before:pr-2 before:text-white before:content-['/']" aria-current="page">Reports</li>
    </ol>
  </nav>

<div class="flex flex-wrap -mx-3">
  <!-- Card -->
  <div class="w-full px-6 py-6 mx-auto">
    <div class="w-full max-w-full">
      <div class="relative flex flex-col min-w-0 break-words bg-white border-0 shadow-xl
                  dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">

        <!-- Header -->
        <div class="p-4">
          <h6 class="mb-4 font-semibold text-lg">Query Parameters</h6>

          <!-- Group 1: Dataset Info -->
          <div class="flex flex-wrap -mx-2">
            <!-- Data Type -->
            <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
              <label  class="block mb-1 text-sm font-medium text-slate-600">Data Type</label>
              <select id="datatype" class="select2-dropdown" multiple>
                <option value="">Select Data Type</option>
                {% for datatype in datatypes %}
                  <option value="{{ datatype.id }}">{{ datatype.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Category -->
            <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
              <label class="block mb-1 text-sm font-medium text-slate-600">Category</label>
              <select id="category" class="select2-dropdown" multiple disabled>
                <option value="">Select Category</option>
                {% for category in categories %}
                  <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Class -->
            <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
              <label class="block mb-1 text-sm font-medium text-slate-600">Class</label>
              <select id="class" class="select2-dropdown" multiple disabled>
                <option value="">Select Class</option>
              </select>
            </div>

            <!-- Sub Class -->
            <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
              <label class="block mb-1 text-sm font-medium text-slate-600">Sub Class</label>
              <select id="subclass" class="select2-dropdown" multiple disabled>
                <option value="">Select Subclass</option>
              </select>
            </div>
          </div>

          <!-- Separator -->
          <hr class="my-4 border-primary bg-primary">

          <!-- Group 2: Location Info -->
          <div class="flex flex-wrap -mx-2">
            <!-- Region -->
            <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
              <label class="block mb-1 text-sm font-medium text-slate-600">Region</label>
              <select id="region" class="select2-dropdown" multiple>
                <option value="">Select Region</option>
                {% for region in regions %}
                  <option value="{{ region.id }}">{{ region.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Community -->
            <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
              <label class="block mb-1 text-sm font-medium text-slate-600">Community</label>
              <select id="community" class="select2-dropdown" multiple disabled>
                <option value="">Select Community</option>
              </select>
            </div>

            <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
              <label class="block mb-1 text-sm font-medium text-slate-600">Time Of Day</label>
              <select id="timeofday" class="select2-dropdown" multiple type="text" placeholder="Enter value"
                class="focus:shadow-primary-outline text-sm block w-full rounded-lg border border-gray-300 px-3 py-2">
 <option value="">Select time of day</option>
                {% for time in timeofday %}
                  <option value="{{ time.id }}">{{ time.name }}</option>
                {% endfor %}

                </select>
            </div>
          </div>

          <!-- Separator -->
          <hr class="my-4 border-gray-300">

          <!-- Group 3: Recording Info -->
          <div class="flex flex-wrap -mx-2">
            <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
              <label class="block mb-1 text-sm font-medium text-slate-600">Recording Date Range</label>
              <input type="text" id="dateRange" placeholder="Select date range"
                class="focus:shadow-primary-outline text-sm block w-full rounded-lg border border-gray-300 px-3 py-2">
            </div>

            <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
              <label class="block mb-1 text-sm font-medium text-slate-600">Recording Device</label>
              <input type="text" placeholder="Enter value"
                class="focus:shadow-primary-outline text-sm block w-full rounded-lg border border-gray-300 px-3 py-2">
            </div>

            <div class="w-full sm:w-1/2 lg:w-1/4 px-2 mb-4">
              <label class="block mb-1 text-sm font-medium text-slate-600">Microphone Type</label>
              <select id="microphone" class="select2-dropdown" multiple>
                <option value="">Select microphone type</option>
                {% for microphone in microphones %}
                  <option value="{{ microphone.id }}">{{ microphone.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="w-full px-2 mb-4">
            <form id="searchForm" method="post">
  {% csrf_token %}
  <!-- all your filter fields -->
  <button type="button" id="searchBtn"
    class="bg-primary text-white font-bold py-2 px-4 rounded-lg text-sm w-full mt-6">
    Search
  </button>
</form>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Results Table -->
<div class="flex flex-wrap -mx-3 mt-6">
  <div class="w-full px-6 py-6 mx-auto">
    <div class="w-full max-w-full">
      <div class="relative flex flex-col min-w-0 break-words bg-white border-0 shadow-xl
                  dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">

        <div class="p-4">
          <h6 class="mb-4 font-semibold text-lg">Search Results</h6>
          <div id="stats" class="mb-4 text-base text-gray-700">
  <span class="">Total Duration: <span id="totalDuration" class="font-bold">0</span> hrs</span> |
  <span>Average Duration: <span  class="font-bold" id="avgDuration">0</span class="font-bold"> secs</span>
</div>

          <!-- Table -->
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3">ID</th>
                  <th scope="col" class="px-6 py-3" style="word-break:keep-all;white-space: nowrap;">Data Type</th>
                  <th scope="col" class="px-6 py-3">Category</th>
                  <th scope="col" class="px-6 py-3">Class</th>
                  <th scope="col" class="px-6 py-3" style="word-break:keep-all;white-space: nowrap;">Sub Class</th>
                  <th scope="col" class="px-6 py-3">Region</th>
                  <th scope="col" class="px-6 py-3">Community</th>
                  <th scope="col" class="px-6 py-3" style="word-break:keep-all;white-space: nowrap;">Recording Date</th>
                  <th scope="col" class="px-6 py-3">Actions</th>
                </tr>
              </thead>
              <tbody id="resultsTableBody">
                <!-- Initial state -->
                <tr class="bg-white border-b">
                  <td colspan="9" class="px-6 py-4 text-center text-gray-500" id="initialMessage">
                    Use the search filters above to find data
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="flex items-center justify-between mt-4">
            <span class="text-sm text-gray-700">
              Showing <span class="font-medium">0</span> to <span class="font-medium">0</span>
              of <span class="font-medium">0</span> results
            </span>
            <nav aria-label="Pagination">
              <ul class="inline-flex -space-x-px">
                <li>
                  <a href="#" class="px-3 py-2 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700">
                    Previous
                  </a>
                </li>
                <li>
                  <a href="#" class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700">1</a>
                </li>
                <li>
                  <a href="#" class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700">
                    Next
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Skeleton Loading Template (Hidden by default) -->
<template id="skeletonTemplate">
  <tr class="bg-white border-b dark:bg-slate-850 dark:border-white/40">
    <td class="p-2">
      <div class="animate-pulse">
        <div class="skeleton-cell medium"></div>
      </div>
    </td>
    <td class="p-2 text-center">
      <div class="animate-pulse">
        <div class="skeleton-cell short"></div>
      </div>
    </td>
    <td class="p-2 text-center">
      <div class="animate-pulse">
        <div class="skeleton-cell long"></div>
      </div>
    </td>
    <td class="p-2 text-center">
      <div class="animate-pulse">
        <div class="skeleton-cell medium"></div>
      </div>
    </td>
    <td class="p-2 text-center">
      <div class="animate-pulse">
        <div class="skeleton-cell short"></div>
      </div>
    </td>
    <td class="p-2 text-center">
      <div class="animate-pulse">
        <div class="skeleton-cell medium"></div>
      </div>
    </td>
    <td class="p-2 text-center">
      <div class="animate-pulse">
        <div class="skeleton-cell long"></div>
      </div>
    </td>
    <td class="p-2 text-center">
      <div class="animate-pulse">
        <div class="skeleton-cell medium"></div>
      </div>
    </td>
    <td class="p-2 text-center">
      <div class="animate-pulse flex gap-2 justify-center">
        <div class="skeleton-cell short"></div>
        <div class="skeleton-cell short"></div>
      </div>
    </td>
  </tr>
</template>


<!-- Include CSS for Flatpickr and Select2 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

<!-- Custom CSS to match existing styles -->
<style>
.select2-container {
  width: 100% !important;
}

.select2-container--default .select2-selection--multiple {
  border: 1px solid #d1d5db !important;
  border-radius: 0.5rem !important;
  font-size: 0.875rem !important;
  padding: 0.375rem 0.75rem !important;
  min-height: 2.5rem !important;
  background-color: white !important;
}

.select2-container--default .select2-selection--multiple:focus-within {
  box-shadow: 0 0 0 1px #005450 !important;
  border-color: #005450 !important;
}

.select2-container--default .select2-selection--multiple .select2-selection__choice {
  background-color: #005450 !important;
  border: 1px solid #005450 !important;
  color: white !important;
  border-radius: 0.25rem !important;
  font-size: 0.75rem !important;
}

.select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
  color: white !important;
}

.select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
  background-color: transparent !important;
  color: #fbbf24 !important;
}

.select2-dropdown {
  border: 1px solid #d1d5db !important;
  border-radius: 0.5rem !important;
  font-size: 0.875rem !important;
}

.select2-container--default.select2-container--disabled .select2-selection--multiple {
  background-color: #f3f4f6 !important;
  cursor: not-allowed !important;
}

.flatpickr-input {
  background-color: white !important;
}

.flatpickr-calendar {
  border-radius: 0.5rem !important;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
}

/* Skeleton animation */
@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: .5;
  }
}

.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
</style>

<!-- Include JavaScript libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  flatpickr("#dateRange", { mode: "range", dateFormat: "Y-m-d" });
  $(".select2-dropdown").select2({ allowClear: true, width: "100%" });

  let currentPage = 1;
  let isLoading = false;

  function showSkeleton(rows = 5) {
    const tbody = document.getElementById("resultsTableBody");
    const skeletonTemplate = document.getElementById("skeletonTemplate");

    // Clear existing content
    tbody.innerHTML = '';

    // Add skeleton rows
    for (let i = 0; i < rows; i++) {
      const clone = skeletonTemplate.content.cloneNode(true);
      tbody.appendChild(clone);
    }

    isLoading = true;
  }

  function hideSkeleton() {
    isLoading = false;
  }



  function populateDropdown(url, params, targetSelectId) {
  const targetSelect = $(`#${targetSelectId}`);
  targetSelect.prop("disabled", true); // disable while loading
  targetSelect.empty().append(new Option(`Loading...`, ""));

  $.ajax({
    url: url,
    method: "GET",
    data: params,
    success: function (data) {
      targetSelect.empty(); // clear previous
      if (data.length > 0) {
        targetSelect.append(new Option("Select option", ""));
        data.forEach(item => {
          targetSelect.append(new Option(item.name, item.id));
        });
        targetSelect.prop("disabled", false); // enable
      } else {
        targetSelect.append(new Option("No results found", ""));
      }
    },
    error: function () {
      targetSelect.empty().append(new Option("Error loading data", ""));
    }
  });
}

$(document).ready(function () {
  // When DataType changes -> load Categories
  $("#datatype").on("change", function () {
    let ids = $(this).val(); // array of selected IDs
    if (ids && ids.length > 0) {
      populateDropdown(
        "/reports/dependent-dropdown/",
        { datatype_ids: ids.join(",") },
        "category"
      );
    } else {
      $("#category").prop("disabled", true).empty().append(new Option("Select Category", ""));
      $("#class").prop("disabled", true).empty().append(new Option("Select Class", ""));
      $("#subclass").prop("disabled", true).empty().append(new Option("Select Subclass", ""));
    }
  });

  // When Category changes -> load Classes
  $("#category").on("change", function () {
    let ids = $(this).val();
    if (ids && ids.length > 0) {
      populateDropdown(
        "/reports/dependent-dropdown/",
        { category_ids: ids.join(",") },
        "class"
      );
    } else {
      $("#class").prop("disabled", true).empty().append(new Option("Select Class", ""));
      $("#subclass").prop("disabled", true).empty().append(new Option("Select Subclass", ""));
    }
  });

  // When Class changes -> load Subclasses
  $("#class").on("change", function () {
    let ids = $(this).val();
    if (ids && ids.length > 0) {
      populateDropdown(
        "/reports/dependent-dropdown/",
        { class_ids: ids.join(",") },
        "subclass"
      );
    } else {
      $("#subclass").prop("disabled", true).empty().append(new Option("Select Subclass", ""));
    }
  });

  // When Region changes -> load Communities
  $("#region").on("change", function () {
    let ids = $(this).val();
    if (ids && ids.length > 0) {
      populateDropdown(
        "/reports/dependent-dropdown/",
        { region_ids: ids.join(",") },
        "community"
      );
    } else {
      $("#community").prop("disabled", true).empty().append(new Option("Select Community", ""));
    }
  });
});


  function performSearch(page = 1) {
    // Show loading skeleton
    showSkeleton(5);

    const searchParams = {
      datatypes: $("#datatype").val() || [],
      categories: $("#category").val() || [],
      classes: $("#class").val() || [],
      subclasses: $("#subclass").val() || [],
      regions: $("#region").val() || [],
      communities: $("#community").val() || [],
      microphones: $("#microphone").val() || [],
      dateRange: $("#dateRange").val(),
      timeOfDay: $("#timeofday").val() || [],
      recordingDevice: document.querySelectorAll('[placeholder="Enter value"]')[1].value
    };

    fetch(`/reports/report-writer/?page=${page}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
      },
      body: JSON.stringify(searchParams)
    })
      .then(res => res.json())
      .then(data => {
        console.log(data)
        hideSkeleton();
        updateResultsTable(data.results.results);
        updatePagination(data, page);
        updateStats(data.results);
      })
      .catch(err => {
        console.error("Search error:", err);
        hideSkeleton();
        // Show error message
        document.getElementById("resultsTableBody").innerHTML = `
          <tr class="bg-white border-b">
            <td colspan="9" class="px-6 py-4 text-center text-red-500">
              Error loading data. Please try again.
            </td>
          </tr>
        `;
      });
  }

  function updateStats(results) {
    document.getElementById("totalDuration").textContent = results.total_duration || 0;
    document.getElementById("avgDuration").textContent = results.average_duration || 0;
  }

  function updateResultsTable(results) {
    const tbody = document.getElementById("resultsTableBody");
    if (results && results.length > 0) {
      tbody.innerHTML = results.map(item => `
        <tr class="bg-white border-b dark:bg-slate-850 dark:border-white/40 hover:bg-gray-50 dark:hover:bg-slate-800">
          <td class="p-2 align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
            <div class="flex px-2 py-1">
              <div class="flex flex-col justify-center">
                <h6 class="mb-0 text-sm leading-normal dark:text-white">${item.noise_id || item.id}</h6>
              </div>
            </div>
          </td>
          <td class="p-2 text-center align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
            <span class="text-sm font-semibold leading-tight dark:text-white dark:opacity-80 text-slate-400">${item.dataset_type?.name || '-'}</span>
          </td>
          <td class="p-2 text-center align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
            <span class="bg-gradient-to-tl from-emerald-500 to-teal-400 px-2.5 text-xs rounded-1.8 py-1.4 inline-block whitespace-nowrap text-center align-baseline font-bold uppercase leading-none text-white">${item.category?.name || '-'}</span>
          </td>
          <td class="p-2 text-center align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
            <span class="text-sm font-semibold leading-tight dark:text-white dark:opacity-80 text-slate-400">${item.class_name?.name || '-'}</span>
          </td>
          <td class="p-2 text-center align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
            <span class="text-sm font-semibold leading-tight dark:text-white dark:opacity-80 text-slate-400">${item.subclass?.name || '-'}</span>
          </td>
          <td class="p-2 text-center align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
            <span class="text-sm font-semibold leading-tight dark:text-white dark:opacity-80 text-slate-400">${item.region?.name || '-'}</span>
          </td>
          <td class="p-2 text-center align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
            <span class="text-sm font-semibold leading-tight dark:text-white dark:opacity-80 text-slate-400">${item.community?.name || '-'}</span>
          </td>
          <td class="p-2 text-center align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
            <span class="text-sm font-semibold leading-tight dark:text-white dark:opacity-80 text-slate-400">
              ${item.recording_date ? new Date(item.recording_date).toLocaleString() : '-'}
            </span>
          </td>
          <td class="p-2 align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
            <div class="flex flex-row items-center justify-center gap-4">
              <a href="/dataset/detail/${item.id}/" class="text-sm mr-2 font-semibold leading-tight dark:text-white dark:opacity-80 text-slate-400">View</a>
            </div>
          </td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = `
        <tr class="bg-white border-b">
          <td colspan="9" class="px-6 py-4 text-center text-gray-500">
            No results found
          </td>
        </tr>
      `;
    }
  }

  function updatePagination(data, page) {
    const total = data.count;
    const pageSize = data.results.results.length;
    const start = total > 0 ? (page - 1) * pageSize + 1 : 0;
    const end = Math.min(start + pageSize - 1, total);

    document.querySelector(".text-sm.text-gray-700").innerHTML = `
      Showing <span class="font-medium">${start}</span> to
      <span class="font-medium">${end}</span> of
      <span class="font-medium">${total}</span> results
    `;

    const pagination = document.querySelector("ul.inline-flex");
    pagination.innerHTML = `
      <li><a href="#" class="px-3 py-2 ${page===1?'text-gray-300 pointer-events-none':'text-gray-500'} border border-gray-300 rounded-l-lg">Previous</a></li>
      <li><a href="#" class="px-3 py-2 bg-gray-200 border border-gray-300">${page}</a></li>
      <li><a href="#" class="px-3 py-2 ${!data.next?'text-gray-300 pointer-events-none':'text-gray-500'} border border-gray-300 rounded-r-lg">Next</a></li>
    `;

    pagination.querySelectorAll("a").forEach((btn, idx) => {
      btn.addEventListener("click", e => {
        e.preventDefault();
        if (idx === 0 && page > 1) performSearch(page - 1);
        if (idx === 2 && data.next) performSearch(page + 1);
      });
    });
  }

  document.getElementById("searchBtn").addEventListener("click", () => {
    currentPage = 1;
    performSearch(currentPage);
  });
});
</script>

{% endblock %}
